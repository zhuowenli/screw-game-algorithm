# 《"解救螺丝"游戏核心算法设计文档》

**文档目的**：本文档旨在详细阐述"解救螺丝"H5原型游戏的核心算法逻辑，为策划、产品及管理人员提供一个清晰、全面的算法行为参考，以便于理解游戏机制、评估玩法深度，并为后续3D项目的开发提供坚实的理论基础。

## 第一部分：关卡生成与布局的核心理念

1. **可解性是第一原则：先定盒，后造物**
    * **问题**：如何从根本上杜绝"随机"导致游戏无解（例如，某种颜色的螺丝不是3的倍数）？
    * **解决方案**：我们摒弃了"随机生成螺丝再随机摆放"的旧模式，采用"数据驱动生成"的全新架构。
        * **步骤1：规划"盒子蓝图" (`boxColorPlan`)**：算法首先确定本关卡总共有多少个盒子、每种颜色各有多少个。这从源头上保证了每种颜色的螺丝总量必然是3的倍数。
        * **步骤2：生成"螺丝清单" (`screwColorPlan`)**：基于"盒子蓝图"，生成一个包含本关卡所有螺丝颜色信息的总清单。
        * **步骤3：创建"组件数据" (`components`)**：算法将"螺丝清单"中的螺丝，按设计好的规则（例如，大板块消耗更多螺丝）分配到不同的"组件"（即带有多层螺丝的板块）数据结构中。**此阶段只生成数据，不涉及任何位置摆放。**
    * **设计目的**：将"关卡数据生成"与"游戏物体摆放"彻底分离，从数学上保证了关卡100%可解。

2. **动态上场：JIT（Just-In-Time）组件生成机制**
    * **问题**：如果一次性把所有板块都摆上场，会导致屏幕拥挤不堪，且可能因为找不到空间而丢弃板块，再次破坏可解性。
    * **解决方案**：我们引入了"动态上场"机制。
        * **初始布局**：游戏开始时，只根据配置（`gameConfig.INITIAL_SPAWN_COUNTS`）生成少量初始板块。
        * **按需补充**：当玩家完全消除一个板块上的所有螺丝后，系统会从待上场的"组件数据"列表中，选择下一个，并**在此时**为它寻找一个合适的位置生成出来。
        * **智能填充**：当场上螺丝总数低于某个阈值（`gameConfig.MIN_ONBOARD_SCREWS`）时，系统也会主动触发补充机制，保证场上始终有足够的操作对象。
    * **设计目的**：保证游戏版面清爽，避免信息过载；彻底解决因空间不足而丢弃螺丝导致无解的隐患。

3. **颜色分级登场：平滑的学习曲线**
    * **问题**：开局就出现七八种颜色，会让玩家感到混乱和挫败。
    * **解决方案**：引入"颜色阶梯" (`colorTiers`)概念。
        * **颜色分层**：在生成"螺丝清单"后，算法会根据颜色在`ALL_COLORS`数组中的顺序，自动将它们分为三六九等（例如，前4种为T1，中间3种为T2，后续为T3）。
        * **组件染色**：在创建"组件数据"时，每个组件会被标记上它所包含的"最早"的颜色等级。
        * **优先上场**：在"动态上场"机制选择下一个要生成的组件时，**会优先选择包含T1颜色的组件，然后是T2，最后是T3**。
    * **设计目的**：为玩家打造一条平滑的学习曲线。前期只会遇到几种基础颜色，随着游戏进程，新颜色会逐渐、可控地被引入，降低了新手的入门门槛。

## 第二部分：动态难度与"卡点"设计

1. **四阶段难度曲线 (`getStageModifiers`)**
    * **理念**：游戏的挑战性不应一成不变，而是要随着玩家的进度动态起伏，形成"心流"体验。
    * **实现**：我们基于玩家的"关卡进度"（已消除螺丝数 / 总螺丝数）将一局游戏划分为四个动态阶段：
        * **阶段0：新手保护期 (<10%)**：此阶段，螺丝被锁住的概率**极低**。目的是让玩家无障碍地熟悉核心操作。
        * **阶段1：普通期 (10% ~ 30%)**：恢复到正常的锁定概率。
        * **阶段2：紧张期 (30% ~ 50%)**：锁定概率和单个锁的复杂度（同时控制的螺丝数）开始提升。
        * **阶段3：危险期 (50% ~ 70%)**：锁定概率和复杂度**显著提升**，并可能出现额外的连锁锁定。
        * **阶段4：决胜期 (>70%)**：难度达到顶峰，旨在给玩家制造终极挑战。
    * **设计目的**：创造一种"呼吸感"，从轻松上手到逐渐紧张，再到冲刺挑战，丰富了单局游戏的情绪体验。

2. **"慈母/严师"型智能盒子AI (`setupBox`)**
    * **问题**：如何让"发牌"（生成新盒子）这个行为本身也充满策略，而不是简单的随机？
    * **解决方案**：我们为盒子生成器设计了一个具备"情境意识"的AI。
        * **游戏前期（进度 < 50%），扮演"慈母"**：AI会优先提供那些玩家**最容易消除**的颜色盒子。它会分析场上局势，如果发现有3个或以上的红色螺丝是裸露的（未被锁定），它就会倾向于给你一个红盒子，帮你快速清理版面，建立优势。
        * **游戏后期（进度 > 50%），扮演"严师"**：AI的策略180度大转弯。它会**故意**提供那些螺丝**大部分都被锁住**的颜色盒子。比如，场上有很多绿螺丝，但它们都被其他颜色锁着，AI偏偏就给你一个绿盒子。
    * **设计目的**：这是一种高级的"卡点"设计。在后期，它逼迫玩家必须去思考如何"解开"那些被锁的螺丝，而不是无脑地"有什么消什么"，极大地提升了游戏的策略深度和后期趣味性。

3. **两大核心防死锁机制 (`cleanupOrphanLocks`)**
    * **问题**：复杂的锁定关系可能意外产生玩家无法解开的"死锁"局面。
    * **解决方案**：我们内置了两个强大的"死锁终结者"机制，在每次操作后都会静默运行，保证公平性。
        * **板块内死锁防护**：当一个新板块生成时，算法会检查是否该板块上的**所有**螺丝都被锁住了。如果是，它会自动解开其中一个，保证该板块至少有一个突破口。
        * **循环锁自动破解**：算法能检测出更复杂的跨螺丝死锁，例如"螺丝A锁住B，B锁住C，C又锁住A"形成的无解循环。一旦侦测到这种循环，它会**自动断开**其中一环，将死锁破解。
    * **设计目的**：这是游戏的"公平底线"。它向玩家保证，无论局面多么复杂，永远存在解法，所有困难都是策略问题，而非系统bug。

4. **动态盒子候选池：确保相关性**
    * **问题**：场上明明一个绿螺丝都没有了，系统却给了一个绿盒子，会让玩家感到困惑和不公。
    * **解决方案**：盒子生成器在选择下一个盒子颜色前，会执行一个**动态筛选**。
        * **第一步：检查库存**：永久淘汰那些在**整个关卡**中已经被完全消除的颜色。
        * **第二步：扫描战场**：动态地观察**当前场上**存在哪些颜色的螺丝。
        * **第三步：生成候选**：只有那些"库存里还有"且"当前在场上能看到"的颜色，才有资格成为本次盒子生成的候选颜色。
    * **设计目的**：保证系统提供的"解题工具"（盒子）永远与"题目"（场上的螺丝）相关，避免无效信息干扰，提升游戏逻辑的严密性。

## 第三部分：可配置化

为了方便策划进行快速的玩法迭代和数值调优，我们将所有核心参数提取到了一个名为 `gameConfig` 的中央配置文件中。这包括：

* 棋盘尺寸
* 初始槽位数
* 锁链最大长度
* 各尺寸板块的生成数量和规则
* 动态难度各阶段的阈值和修正系数
* ...等等

策划人员可以在不接触任何核心代码的情况下，通过修改这个配置文件，直观地调整游戏的方方面面。
