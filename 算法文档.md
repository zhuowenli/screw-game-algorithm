# 《"解救螺丝"游戏核心算法设计文档》

**版本：V3.1 (最终稳定版)**

**文档目的**：本文档旨在详细阐述"解救螺丝"H5原型游戏的核心算法逻辑，为策划、产品及管理人员提供一个清晰、全面的算法行为参考，以便于理解游戏机制、评估玩法深度，并为后续3D项目的开发提供坚实的理论基础。

## 第一部分：关卡生成与布局的核心理念

### 1. 可解性是第一原则：先定盒，后造物

* **问题**：如何从根本上杜绝"随机"导致游戏无解（例如，某种颜色的螺丝不是3的倍数）？
* **解决方案**：我们摒弃了"随机生成螺丝再随机摆放"的旧模式，采用"数据驱动生成"的全新架构。
  * **步骤1：规划"盒子蓝图" (`boxColorPlan`)**：算法首先确定本关卡总共有多少个盒子、每种颜色各有多少个。这从源头上保证了每种颜色的螺丝总量必然是3的倍数。
  * **步骤2：生成"螺丝清单" (`screwColorPlan`)**：基于"盒子蓝图"，生成一个包含本关卡所有螺丝颜色信息的总清单。
  * **步骤3：创建"组件数据" (`components`)**：算法将"螺丝清单"中的螺丝，按设计好的规则（例如，大板块消耗更多螺丝）分配到不同的"组件"（即带有多层螺丝的板块）数据结构中。**此阶段只生成数据，不涉及任何位置摆放。**
* **设计目的**：将"关卡数据生成"与"游戏物体摆放"彻底分离，从数学上保证了关卡100%可解。

### 2. 动态上场与紧急放置：保证流畅性

* **问题**：如果一次性把所有板块都摆上场，或因版面拥挤而找不到"完美"空位，都会导致游戏卡死。
* **解决方案**：我们引入了"双保险"的动态上场机制。
  * **A计划（常规模式）**：游戏开始时，只生成少量初始板块。当玩家消除一个板块或场上螺丝过少时，系统会**优先寻找一块符合设计尺寸（如10x10）的完整空地**来放置新板块。
  * **B计划（紧急模式）**：**仅在A计划失败时**，为杜绝卡死，系统会启动紧急模式。它会在所有可用的空格子中随机选择一个作为**"锚点"**，并围绕该锚点强制定义一个标准尺寸的区域。然后，螺丝会被放置在该区域内的可用空位上。
* **设计目的**：在绝大多数情况下保证组件形态符合设计预期，同时用一个强大的备用方案彻底杜绝因找不到位置而导致的卡死，保证游戏进程绝对流畅。

### 3. 颜色分级登场：平滑的学习曲线

* **问题**：开局就出现七八种颜色，会让玩家感到混乱和挫败。
* **解决方案**：引入"颜色阶梯" (`colorTiers`)概念。
  * **颜色分层**：算法将本关卡的颜色自动分为"早、中、晚"三个阶段。
  * **优先上场**：在动态上场时，**永远优先选择包含"早期"颜色的板块**。
* **设计目的**：为玩家打造一条平滑的学习曲线。前期只会遇到几种基础颜色，随着游戏进程，新颜色会逐渐、可控地被引入。

## 第二部分：动态难度与"卡点"设计

### 1. 四阶段难度曲线 (`getStageModifiers`)

* **理念**：游戏的挑战性不应一成不变，而是要随着玩家的进度动态起伏。
* **实现**：我们基于玩家的"关卡进度"，将一局游戏划分为四个动态阶段。每个阶段都会提供一个**核心的"锁生成概率修正值" (`lockProbFactor`)**，它直接影响后续锁生成的几率。
  * **阶段0：新手保护期 (<10%)**：修正值极低，锁非常罕见。
  * **阶段1：普通期 (10% ~ 30%)**：正常修正值。
  * **阶段2：紧张期 (30% ~ 50%)**：修正值提升，锁开始变多、变复杂。
  * **阶段3：危险期 (50% ~ 70%)**：修正值提升，高概率触发锁定。
  * **阶段4：决胜期 (>70%)**：修正值达到顶峰，高概率触发锁定。
* **设计目的**：创造一种"呼吸感"，从轻松上手到逐渐紧张，再到冲刺挑战，丰富了单局游戏的情绪体验。

### 2. "慈母/严师"型智能盒子AI (`setupBox`)

* **问题**：如何让"发牌"（生成新盒子）这个行为本身也充满策略？
* **解决方案**：我们为盒子生成器设计了一个具备"情境意识"的AI。
  * **游戏前期（进度 < 50%），扮演"慈母"**：AI会优先提供那些玩家**最容易消除**的颜色盒子（即场上未被锁定的螺丝数量 >= 3的颜色）。
  * **游戏后期（进度 > 50%），扮演"严师"**：AI的策略180度大转弯。它会**故意**提供那些螺丝**大部分都被锁住**的颜色盒子，逼迫玩家必须去思考如何"解套"，极大提升了策略深度。
* **设计目的**：这是一种高级的"卡点"设计，让游戏从"有什么消什么"变为"想办法去消"。

### 3. 三大防死锁与复杂度控制机制

* **问题**：复杂的锁定关系可能意外产生死锁，或难度失控的"超级锁"。
* **解决方案**：我们内置了三大"护航"机制，在每次操作后都会静默运行。
  * **板块内死锁防护**：当一个新板块生成时，若其上所有螺丝都被锁住，会自动解开一个，保证有突破口。
  * **循环锁自动破解**：能自动检测并断开"A锁B、B锁C、C锁A"这类无解的锁循环。
  * **并联锁纯洁性**：一个螺丝一旦成为"并联锁"（多对一）的控制者，它自身就进入"牺牲"状态，**永远无法再被其他螺丝锁定**。这从根本上杜绝了链条锁与并联锁的恶性叠加，精确地控制了复杂度的上限。
* **设计目的**：向玩家保证，游戏**绝对公平**。所有困难都是策略问题，而非系统bug或失控的随机性。

### 4. 动态盒子候选池：确保相关性

* **问题**：场上明明一个绿螺丝都没有了，系统却给了一个绿盒子。
* **解决方案**：盒子生成器在选择下一个盒子颜色前，会执行一个**动态筛选**。只有那些"库存里还有"且"当前在场上能看到"的颜色，才有资格成为本次盒子生成的候选颜色。
* **设计目的**：保证系统提供的"解题工具"（盒子）永远与"题目"（场上的螺丝）相关。

### 5. 双重决策锁定模型：精确控制难度与类型

* **问题**：如何精确控制"锁的数量"与"锁的类型"（深度vs广度）？
* **解决方案**：这是我们难度算法的核心。当一个新螺丝生成时，它会经过一个"双重决策"模型。
  * **第一关："锁不锁？"** - 算法首先根据**四阶段难度曲线**提供的概率，进行一次判定。如果失败，螺丝保持自由，流程结束。这是控制锁**数量**的总开关。
  * **第二关："怎么锁？"** - **只有通过第一关后**，算法才会进入此关。它会根据难度等级配置的`CHAIN_LOCK_PROBABILITY`，来决定本次是生成**"链条锁"**（延长现有锁链，增加破解深度）还是**"并联锁"**（被多个新锁控制，增加破解广度）。
  * **跨板块锁定**：为了解决后期小板块无法形成有效锁定的问题，我们允许锁**跨越板块边界**，去锁定附近的螺丝（有距离限制），确保了游戏后期的挑战性始终如一。
* **设计目的**：将"锁的数量"和"锁的复杂度"这两个核心难度维度彻底解耦，让策划可以通过调整不同参数，像调音台一样精确地设计每一关的难度体验。

## 第三部分：可配置化与难度曲线

为了方便策划进行快速的玩法迭代和数值调优，我们将所有核心参数提取到了一个名为 `gameConfig` 的中央配置文件中。同时，我们建立了一套50个等级的难度曲线，每个等级都包含了一整套配置，可以直接覆盖`gameConfig`的默认值。

通过调整这50个等级的插值函数，策划可以平滑地控制以下所有核心的游戏参数：

* **核心参数**：螺丝颜色种类、盒子总数。
* **锁生成算法**：
  * `maxLockGroups`: 场上总锁组数量
  * `maxControllers`: 并联锁的最大广度
  * `chainLockProbability`: 链式锁的生成概率（影响深度）
* **游戏节奏**：
  * `minOnboardScrews`: 场上最小螺丝数（影响版面拥挤程度）

UI界面上新增的"难度配置详情"面板，会实时、清晰地展示出所选难度等级下的所有后台参数，让设计过程完全透明。
