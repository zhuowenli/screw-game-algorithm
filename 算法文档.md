# 《"解救螺丝"游戏核心算法设计文档》

**版本：V3.3 (动态配置版)**

**文档目的**：本文档旨在详细阐述"解救螺丝"H5原型游戏的核心算法逻辑，为策划、产品及管理人员提供一个清晰、全面的算法行为参考，以便于理解游戏机制、评估玩法深度，并为后续3D项目的开发提供坚实的理论基础。

## 第一部分：关卡生成与布局的核心理念

### 1. 可解性是第一原则：先定盒，后造物

* **问题**：如何从根本上杜绝"随机"导致游戏无解（例如，某种颜色的螺丝不是3的倍数）？
* **解决方案**：我们摒弃了"随机生成螺丝再随机摆放"的旧模式，采用"数据驱动生成"的全新架构。算法首先确定本关卡总共有多少个盒子、每种颜色各有多少个。这从源头上保证了每种颜色的螺丝总量必然是3的倍数。然后再根据这份"蓝图"去生成具体的螺丝和板块数据。
* **设计目的**：将"数据规划"与"实体摆放"彻底分离，从数学上保证了关卡100%可解。

### 2. 动态上场与紧急放置：保证流畅性

* **问题**：如果一次性把所有板块都摆上场，或因版面拥挤而找不到"完美"空位，都会导致游戏卡死。
* **解决方案**：我们引入了"双保险"的动态上场机制。
  * **A计划（常规模式）**：游戏开始时，只生成少量初始板块。当玩家消除一个板块或场上螺丝过少时，系统会**优先寻找一块符合设计尺寸（如10x10）的完整空地**来放置新板块。
  * **B计划（紧急模式）**：**仅在A计划失败时**，为杜绝卡死，系统会启动紧急模式。它会在所有可用的空格子中随机选择一个作为**"锚点"**，并围绕该锚点强制定义一个标准尺寸的区域。然后，螺丝会被放置在该区域内的可用空位上。
* **设计目的**：在绝大多数情况下保证组件形态符合设计预期，同时用一个强大的备用方案彻底杜绝因找不到位置而导致的卡死，保证游戏进程绝对流畅。

### 3. 颜色分级登场：平滑的学习曲线

* **问题**：开局就出现七八种颜色，会让玩家感到混乱和挫败。
* **解决方案**：引入"颜色阶梯" (`colorTiers`)概念。
  * **颜色分层**：算法将本关卡的颜色自动分为"早、中、晚"三个阶段。
  * **优先上场**：在动态上场时，**永远优先选择包含"早期"颜色的板块**。
* **设计目的**：为玩家打造一条平滑的学习曲线。前期只会遇到几种基础颜色，随着游戏进程，新颜色会逐渐、可控地被引入。

## 第二部分：动态难度与两大核心"卡点"设计

### 1. [重构] 完全动态的难度曲线

* **理念**：游戏的挑战性不应一成不变，更不应被硬编码限制。策划应能自由设计难度曲线的每一个细节。
* **实现**：我们引入了**完全动态化的阶段配置系统**。现在，一局游戏的核心难度不再是固定的4个阶段，而是可以**在UI界面上自由增删、配置任意多个阶段**。
  * **动态难度阶段配置**: 控制**"锁多不多"**。它允许你为不同的游戏进度（`progressThreshold`）设置不同的**锁生成基础概率**（`lockProbFactor`）和**并联锁数量系数**（`connectionMultiplier`）。
  * **锁链长度阶段配置**: 控制**"锁难不难"**。这里的"长度"实际指的是**并联锁的广度**。它允许你为不同的游戏进度设置一个螺丝**最多能被几个其他螺丝同时锁定**（`controllerLimit`）。
* **设计目的**：将难度设计的权柄完全交给策划。通过UI的直观操作，可以精确地创造出"前期平缓，中期陡峭，后期波动"等任意形式的难度曲线，极大地提升了设计的自由度和迭代效率。

### 2. 卡点设计一：智能盒子AI (`setupBox`)

* **问题**：如何让"发牌"（生成新盒子）这个行为本身也充满策略？
* **解决方案**：我们为盒子生成器设计了一个具备"情境意识"的AI。
  * **游戏前期（进度 < 阈值），扮演"慈母"**：AI会优先提供那些玩家**最容易消除**的颜色盒子（即场上未被锁定的螺丝数量 >= 3的颜色）。
  * **游戏后期（进度 > 阈值），扮演"严师"**：AI的策略180度大转弯。它会**故意**提供那些螺丝**大部分都被锁住**的颜色盒子，逼迫玩家必须去思考如何"解套"，极大提升了策略深度。
* **设计目的**：这是一种高级的"卡点"设计，让游戏从"有什么消什么"变为"想办法去消"。

### 3. 卡点设计二：板块生成锁定 (`setupLocks`)

* **问题**：玩家可以通过不断消除其他板块，刷出新板块来获得"自由"的螺丝，从而绕开当前被卡住的颜色。
* **解决方案**：我们建立了一套强大的"锁定继承"机制。当一个新板块即将生成时，算法会检查场上所有**未满的盒子**。如果场上有一个未满的蓝色盒子，那么这个新生成板块上的**所有蓝色螺丝**都会被自动锁定。
* **设计目的**：这强制玩家必须正面解决当前的"卡点颜色"，而不能通过刷板块来"作弊"，极大地强化了核心解谜循环的闭环。

### 4. [重构] 锁生成决策模型：确定性与策略性

* **问题**：如何精确控制锁的生成，并确保其行为符合策略预期？
* **解决方案**：我们重构了锁的生成模型，用更具确定性的逻辑取代了旧的概率模型。
  * **第一关："锁不锁？"** - 算法首先根据**动态难度阶段**提供的`lockProbFactor`，进行一次判定。这是控制锁**数量**的总开关。
  * **第二关："怎么锁？"** - **只有通过第一关后**，算法才会进入此关，并遵循以下优先级：
    1. **优先链式锁（增深度）**: 如果新螺丝可以被一个**已存在的锁链**继续延长（形成 A->B->C 的结构），算法会**优先选择**这么做。这会增加单一目标的破解深度。
    2. **后备并联锁（增广度）**: 如果无法形成链式锁，算法会尝试创建**并联锁**（A->C, B->C）。此时，锁的广度（同时有几个螺丝锁定它）将由**"锁链长度阶段配置"**在当前进度下的`controllerLimit`和`connectionMultiplier`共同决定。
* **设计目的**：移除了不确定性的`CHAIN_LOCK_PROBABILITY`，让锁的类型选择更具策略性。现在，AI会智能地判断是增加现有挑战的"深度"还是创造新挑战的"广度"，同时通过两大动态配置系统精确控制难度。

### 5. 三大防死锁与复杂度控制机制

* **问题**：复杂的锁定关系可能意外产生死锁，或难度失控的"超级锁"。
* **解决方案**：我们内置了三大"护航"机制，在每次操作后都会静默运行。
  * **板块内死锁防护**：当一个新板块生成时，若其上所有螺丝都被锁住，会自动解开一个，保证有突破口。
  * **循环锁自动破解**：能自动检测并断开"A锁B、B锁C、C锁A"这类无解的锁循环。
  * **并联锁纯洁性**：一个螺丝一旦成为"并联锁"（多对一）的控制者，它自身就进入"牺牲"状态，**永远无法再被其他螺丝锁定**。这从根本上杜绝了链条锁与并联锁的恶性叠加，精确地控制了复杂度的上限。
* **设计目的**：向玩家保证，游戏**绝对公平**。所有困难都是策略问题，而非系统bug或失控的随机性。

## 第三部分：[重构] UI驱动的可配置化

为了方便策划进行快速的玩法迭代和数值调优，我们将旧的、基于代码的50级难度曲线，**全面升级为UI驱动的、所见即所得的动态配置系统**。

现在，游戏的核心难度完全由设置面板中的两大动态模块控制，策划可以像搭乐高一样自由地构建难度曲线：

1. **动态难度阶段配置 (控制锁的生成)**:
    * **作用**：决定在游戏的不同阶段，生成锁的基础概率有多大，以及生成并联锁时数量的波动范围。
    * **可配参数**：
        * `进度 <` (`progressThreshold`): 此阶段生效的进度上限。
        * `概率` (`lockProbFactor`): 锁生成的基础概率。
        * `系数` (`connectionMultiplier`): 并联锁数量的修正系数，允许数量在限制范围内有一定浮动。

2. **锁链长度阶段配置 (控制锁的复杂度)**:
    * **作用**：决定在游戏的不同阶段，一个螺丝最多能被几个其他螺丝锁住（即并联锁的广度上限）。
    * **可配参数**：
        * `进度 <` (`progressThreshold`): 此阶段生效的进度上限。
        * `限制` (`controllerLimit`): 并联锁控制者的最大数量。

**核心优势**：这种模式将难度设计的权力完全交给了策划。不再需要修改代码或理解复杂的插值函数，只需在UI上点击 `+` / `-` 并调整数值，即可实时创建、测试和固化任何想要的难度模型，实现了真正意义上的敏捷开发和设计。
